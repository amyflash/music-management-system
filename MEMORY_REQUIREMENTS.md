# éŸ³ä¹ç®¡ç†ç³»ç»Ÿå†…å­˜éœ€æ±‚è¯´æ˜

## ğŸ’¾ å†…å­˜éœ€æ±‚æ¦‚è§ˆ

### æ¨èé…ç½®

| ä½¿ç”¨åœºæ™¯ | VPS å†…å­˜ | é¢„è®¡å ç”¨ | å‰©ä½™ç¼“å†² | æ¨èåº¦ |
|---------|---------|---------|---------|--------|
| ä¸ªäººä½¿ç”¨ï¼ˆ1-2äººï¼‰ | 1 GB | ~600 MB | ~400 MB | â­â­â­â­ |
| å°å›¢é˜Ÿï¼ˆ5-10äººï¼‰ | 2 GB | ~1.2 GB | ~800 MB | â­â­â­â­â­ |
| ä¸­å‹å›¢é˜Ÿï¼ˆ10-50äººï¼‰ | 4 GB | ~2.5 GB | ~1.5 GB | â­â­â­â­â­ |
| ä¸ªäººä½¿ç”¨ï¼ˆæœ€ä½é…ç½®ï¼‰ | 512 MB | ~600 MB | ~0 MB | â­â­ |

## ğŸ“Š è¯¦ç»†å†…å­˜åˆ†é…

### PostgreSQL æ•°æ®åº“

| çŠ¶æ€ | å†…å­˜å ç”¨ |
|------|---------|
| å¯åŠ¨æ—¶ | 100-200 MB |
| ç©ºé—²çŠ¶æ€ | 200-300 MB |
| æœ‰æ•°æ®å | 300-500 MB |
| é«˜å³°æœŸ | 500 MB - 1 GB |

**å†…å­˜é™åˆ¶å»ºè®®ï¼š**
- æœ€å°ï¼š256 MB
- æ¨èï¼š512 MB
- èˆ’é€‚ï¼š1 GB

### Next.js åº”ç”¨

| çŠ¶æ€ | å†…å­˜å ç”¨ |
|------|---------|
| å¯åŠ¨æ—¶ | 300-500 MB |
| ç©ºé—²çŠ¶æ€ | 400-600 MB |
| æœ‰ç”¨æˆ·è®¿é—® | 500-800 MB |
| é«˜å³°æœŸ | 1-2 GB |

**å†…å­˜é™åˆ¶å»ºè®®ï¼š**
- æœ€å°ï¼š512 MB
- æ¨èï¼š1 GB
- èˆ’é€‚ï¼š2 GB

### ç³»ç»Ÿå¼€é”€

| ç»„ä»¶ | å†…å­˜å ç”¨ |
|------|---------|
| Docker è¿è¡Œæ—¶ | 50-100 MB |
| æ“ä½œç³»ç»Ÿ | 100-200 MB |
| å…¶ä»–è¿›ç¨‹ | 50-100 MB |

**æ€»è®¡ï¼š200-400 MB**

## ğŸ¯ ä¸åŒ VPS é…ç½®

### 512 MB VPSï¼ˆä¸æ¨èï¼‰

- âœ… å¯ä»¥è¿è¡Œï¼Œä½†ï¼š
  - å¯èƒ½å› å†…å­˜ä¸è¶³è¢« OOM Kill
  - æ€§èƒ½è¾ƒå·®
  - ä¸æ”¯æŒå¹¶å‘ç”¨æˆ·
  - æ•°æ®åº“å¯èƒ½å´©æºƒ

### 1 GB VPSï¼ˆæœ€ä½æ¨èï¼‰

- âœ… é€‚åˆä¸ªäººä½¿ç”¨
- âš ï¸ æœ€å¤š 1-2 äººåŒæ—¶ä½¿ç”¨
- âš ï¸ ä¸Šä¼ å¤§æ–‡ä»¶å¯èƒ½å¡é¡¿
- âœ… æˆæœ¬ä½ï¼ˆçº¦ $5/æœˆï¼‰

**å®é™…åˆ†é…ï¼š**
- PostgreSQL: 256 MB
- Next.js: 512 MB
- ç³»ç»Ÿ: 232 MB

### 2 GB VPSï¼ˆæ¨èï¼‰

- âœ… é€‚åˆå°å›¢é˜Ÿï¼ˆ5-10 äººï¼‰
- âœ… æ€§èƒ½ç¨³å®š
- âœ… æ”¯æŒæ–‡ä»¶ä¸Šä¼ 
- âœ… æœ‰è¶³å¤Ÿç¼“å†²

**å®é™…åˆ†é…ï¼š**
- PostgreSQL: 512 MB
- Next.js: 1 GB
- ç³»ç»Ÿ: 488 MB

### 4 GB VPSï¼ˆèˆ’é€‚ï¼‰

- âœ… é€‚åˆä¸­å‹å›¢é˜Ÿï¼ˆ10-50 äººï¼‰
- âœ… æ€§èƒ½ä¼˜ç§€
- âœ… å¯ä»¥è¿è¡Œå…¶ä»–æœåŠ¡
- âœ… æœ‰å¤§é‡ç¼“å†²

**å®é™…åˆ†é…ï¼š**
- PostgreSQL: 1 GB
- Next.js: 2 GB
- ç³»ç»Ÿ: 1 GB

## ğŸ”§ å¦‚ä½•è®¾ç½®å†…å­˜é™åˆ¶

### æ–¹æ³• 1ï¼šä½¿ç”¨ docker-compose-with-memory-limit.yml

æˆ‘å·²ç»åˆ›å»ºäº†å¸¦æœ‰å†…å­˜é™åˆ¶çš„é…ç½®æ–‡ä»¶ï¼š

```bash
# ä½¿ç”¨å¸¦å†…å­˜é™åˆ¶çš„é…ç½®
docker compose -f docker-compose-with-memory-limit.yml up -d
```

**é…ç½®å†…å®¹ï¼š**
```yaml
postgres:
  deploy:
    resources:
      limits:
        memory: 512M
      reservations:
        memory: 256M

app:
  deploy:
    resources:
      limits:
        memory: 1G
      reservations:
        memory: 512M
```

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨è®¾ç½®

ç¼–è¾‘ `docker-compose.yml`ï¼Œå–æ¶ˆæ³¨é‡Šå†…å­˜é™åˆ¶éƒ¨åˆ†ï¼š

```yaml
postgres:
  deploy:
    resources:
      limits:
        memory: 512M      # æœ€å¤§å†…å­˜
      reservations:
        memory: 256M      # ä¿ç•™å†…å­˜

app:
  deploy:
    resources:
      limits:
        memory: 1G        # æœ€å¤§å†…å­˜
      reservations:
        memory: 512M      # ä¿ç•™å†…å­˜
```

## ğŸ“ˆ ç›‘æ§å†…å­˜ä½¿ç”¨

### æŸ¥çœ‹å®¹å™¨å†…å­˜ä½¿ç”¨

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çš„å†…å­˜ä½¿ç”¨
docker stats

# æŒç»­ç›‘æ§
docker stats --format "table {{.Name}}\t{{.MemUsage}}"

# åªæŸ¥çœ‹éŸ³ä¹ç®¡ç†ç³»ç»Ÿ
docker stats music-db music-app
```

### æŸ¥çœ‹ç³»ç»Ÿå†…å­˜ä½¿ç”¨

```bash
# æŸ¥çœ‹ç³»ç»Ÿå†…å­˜
free -h

# æŸ¥çœ‹å†…å­˜è¯¦ç»†ä¿¡æ¯
vmstat -s

# æŸ¥çœ‹è¿›ç¨‹å†…å­˜ä½¿ç”¨
top -o %MEM
```

### æŸ¥çœ‹æ—¥å¿—ä¸­çš„å†…å­˜è­¦å‘Š

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker compose logs app | grep -i "memory\|oom"

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker compose logs postgres | grep -i "memory\|oom"
```

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: å†…å­˜ä¸è¶³ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

**ç—‡çŠ¶ï¼š**
- å®¹å™¨è¢« OOM Killï¼ˆOut Of Memory Killerï¼‰
- åº”ç”¨çªç„¶å´©æºƒ
- æ•°æ®åº“è¿æ¥å¤±è´¥
- ä¸Šä¼ æ–‡ä»¶æ—¶å¡æ­»

**è§£å†³æ–¹æ¡ˆï¼š**
1. å¢åŠ  VPS å†…å­˜
2. é™ä½å†…å­˜é™åˆ¶
3. ä¼˜åŒ–åº”ç”¨ä»£ç 
4. é‡å¯æœåŠ¡

### Q2: å¦‚ä½•çŸ¥é“æ˜¯å¦å†…å­˜ä¸è¶³ï¼Ÿ

**ç›‘æ§æŒ‡æ ‡ï¼š**
- å†…å­˜ä½¿ç”¨ç‡ > 90%
- é¢‘ç¹ OOM Kill
- åº”ç”¨å“åº”å˜æ…¢
- æ—¥å¿—ä¸­å‡ºç° "out of memory"

**å‘½ä»¤ï¼š**
```bash
# æ£€æŸ¥ OOM Kill
dmesg | grep -i "killed process"

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker compose ps
```

### Q3: å¯ä»¥ç”¨ Swap å—ï¼Ÿ

**ç­”æ¡ˆï¼š** å¯ä»¥ï¼Œä½†ä¸æ¨è

**åŸå› ï¼š**
- Swap ä¼šé™ä½æ€§èƒ½
- å¯èƒ½å¯¼è‡´è¶…æ—¶
- ä¸èƒ½å®Œå…¨æ›¿ä»£ç‰©ç†å†…å­˜

**å¦‚æœå¿…é¡»ä½¿ç”¨ï¼š**
```bash
# æ£€æŸ¥ Swap
free -h

# ä¸´æ—¶å¯ç”¨ Swapï¼ˆ1GBï¼‰
sudo fallocate -l 1G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### Q4: å¦‚ä½•ä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼Ÿ

**PostgreSQL ä¼˜åŒ–ï¼š**
```yaml
environment:
  POSTGRES_SHARED_BUFFERS: 256MB
  POSTGRES_WORK_MEM: 16MB
  POSTGRES_EFFECTIVE_CACHE_SIZE: 512MB
```

**Next.js ä¼˜åŒ–ï¼š**
- å‡å°‘å¹¶å‘æ•°
- æ¸…ç†ç¼“å­˜
- ä½¿ç”¨ CDN
- å‹ç¼©èµ„æº

## ğŸš€ éƒ¨ç½²å»ºè®®

### 1 GB VPSï¼ˆä¸ªäººä½¿ç”¨ï¼‰

```yaml
postgres:
  deploy:
    resources:
      limits:
        memory: 256M
      reservations:
        memory: 128M

app:
  deploy:
    resources:
      limits:
        memory: 512M
      reservations:
        memory: 256M
```

### 2 GB VPSï¼ˆå°å›¢é˜Ÿï¼‰

```yaml
postgres:
  deploy:
    resources:
      limits:
        memory: 512M
      reservations:
        memory: 256M

app:
  deploy:
    resources:
      limits:
        memory: 1G
      reservations:
        memory: 512M
```

### 4 GB VPSï¼ˆä¸­å‹å›¢é˜Ÿï¼‰

```yaml
postgres:
  deploy:
    resources:
      limits:
        memory: 1G
      reservations:
        memory: 512M

app:
  deploy:
    resources:
      limits:
        memory: 2G
      reservations:
        memory: 1G
```

## âœ… æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰ç¡®è®¤ï¼š

- [ ] VPS å†…å­˜ â‰¥ 1 GB
- [ ] å·²è®¾ç½®å†…å­˜é™åˆ¶
- [ ] å·²é…ç½®ç›‘æ§
- [ ] å·²è®¾ç½®å‘Šè­¦
- [ ] å·²å‡†å¤‡å¤‡ä»½æ–¹æ¡ˆ

## ğŸ“ æ€§èƒ½é—®é¢˜æ’æŸ¥

å¦‚æœé‡åˆ°æ€§èƒ½é—®é¢˜ï¼š

1. **æŸ¥çœ‹å†…å­˜ä½¿ç”¨**
   ```bash
   docker stats
   ```

2. **æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—**
   ```bash
   dmesg | grep -i "memory\|oom"
   ```

3. **æŸ¥çœ‹åº”ç”¨æ—¥å¿—**
   ```bash
   docker compose logs -f app
   ```

4. **é‡å¯æœåŠ¡**
   ```bash
   docker compose restart
   ```

5. **å¦‚æœé—®é¢˜æŒç»­**
   - å¢åŠ  VPS å†…å­˜
   - ä¼˜åŒ–é…ç½®
   - è”ç³»æŠ€æœ¯æ”¯æŒ

## ğŸ¯ æ€»ç»“

**æœ€å°é…ç½®ï¼š**
- å†…å­˜ï¼š512 MBï¼ˆå‹‰å¼ºï¼‰
- ç”¨æˆ·ï¼š1 äºº
- ä¸æ¨è

**æ¨èé…ç½®ï¼š**
- å†…å­˜ï¼š1 GBï¼ˆä¸ªäººï¼‰æˆ– 2 GBï¼ˆå›¢é˜Ÿï¼‰
- ç”¨æˆ·ï¼š1-10 äºº
- æ¨è

**èˆ’é€‚é…ç½®ï¼š**
- å†…å­˜ï¼š4 GB
- ç”¨æˆ·ï¼š10-50 äºº
- éå¸¸æ¨è

**é€‰æ‹©å»ºè®®ï¼š**
- ä¸ªäººä½¿ç”¨ï¼š1 GB
- å°å›¢é˜Ÿï¼š2 GB
- ä¸­å‹å›¢é˜Ÿï¼š4 GB
- ä¼ä¸šçº§ï¼š8 GB+

**æˆæœ¬å‚è€ƒï¼ˆç¾å…ƒ/æœˆï¼‰ï¼š**
- 512 MBï¼š$3-5
- 1 GBï¼š$5-10
- 2 GBï¼š$10-20
- 4 GBï¼š$20-40
- 8 GBï¼š$40-80
